!function(e){var t={};function s(i){if(t[i])return t[i].exports;var a=t[i]={i:i,l:!1,exports:{}};return e[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)s.d(i,a,function(t){return e[t]}.bind(null,a));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/build/",s(s.s=3)}([function(e,t){e.exports=Howl},function(e,t){e.exports=PIXI},function(e,t){e.exports=Stats},function(e,t,s){"use strict";s.r(t);var i={FPS:50,BRICK_WIDTH:32,BRICK_HEIGHT:16,PLAYER_WIDTH:20,PLAYER_MAX_VELOCITY_X:3,DDEMO_VERSION:0,DDEMO_FIREROCKET:1,DDEMO_PLAYERPOS:2,DDEMO_TIMESET:3,DDEMO_CREATEPLAYER:4,DDEMO_KILLOBJECT:5,DDEMO_FIREBFG:6,DDEMO_FIREPLASMA:7,DDEMO_FIREGREN:8,DDEMO_FIRERAIL:9,DDEMO_FIRESHAFT:10,DDEMO_FIRESHOTGUN:11,DDEMO_FIREMACH:12,DDEMO_ITEMDISSAPEAR:13,DDEMO_ITEMAPEAR:14,DDEMO_DAMAGEPLAYER:15,DDEMO_HAUPDATE:16,DDEMO_FLASH:17,DDEMO_JUMPSOUND:18,DDEMO_GAMEEND:19,DDEMO_RESPAWNSOUND:20,DDEMO_JUMPPADSOUND:21,DDEMO_LAVASOUND:22,DDEMO_POWERUPSOUND:23,DDEMO_EARNPOWERUP:24,DDEMO_READYPRESS:25,DDEMO_FLIGHTSOUND:26,DDEMO_EARNREWARD:27,DDEMO_STATS:28,DDEMO_GAMESTATE:29,DDEMO_TRIXARENAEND:30,DDEMO_OBJCHANGESTATE:31,DDEMO_CORPSESPAWN:32,DDEMO_GRENADESYNC:33,DDEMO_STATS2:34,DDEMO_PLAYERPOSV2:35,DDEMO_FIREGRENV2:36,DDEMO_NOAMMOSOUND:37,DDEMO_GAUNTLETSTATE:38,DDEMO_STATS3:39,DDEMO_FIREPLASMAV2:40,DDEMO_PLAYERPOSV3:41,DDEMO_BUBBLE:42,DDEMO_MPSTATE:43,DDEMO_NETRAIL:44,DDEMO_NETPARTICLE:45,DDEMO_NETTIMEUPDATE:46,DDEMO_NETSVMATCHSTART:47,DDEMO_DROPPLAYER:48,DDEMO_CREATEPLAYERV2:49,DDEMO_SPECTATORCONNECT:50,DDEMO_SPECTATORDISCONNECT:51,DDEMO_CHATMESSAGE:52,DDEMO_PLAYERRENAME:53,DDEMO_PLAYERMODELCHANGE:54,DDEMO_GENERICSOUNDDATA:55,DDEMO_GENERICSOUNDSTATDATA:56,DDEMO_TEAMSELECT:57,DDEMO_CTF_EVENT_FLAGTAKEN:58,DDEMO_CTF_EVENT_FLAGCAPTURE:59,DDEMO_CTF_EVENT_FLAGDROP:60,DDEMO_CTF_EVENT_FLAGPICKUP:61,DDEMO_CTF_EVENT_FLAGDROP_APPLY:62,DDEMO_CTF_EVENT_FLAGRETURN:63,DDEMO_CTF_GAMESTATE:64,DDEMO_CTF_EVENT_FLAGDROPGAMESTATE:65,DDEMO_CTF_GAMESTATESCORE:66,DDEMO_CTF_FLAGCARRIER:67,DDEMO_DOM_CAPTURE:68,DDEMO_DOM_SCORECHANGED:69,DDEMO_WPN_EVENT_WEAPONDROP:70,DDEMO_WPN_EVENT_PICKUP:71,DDEMO_WPN_EVENT_WEAPONDROP_APPLY:72,DDEMO_WPN_EVENT_WEAPONDROPGAMESTATE:73,DDEMO_DOM_CAPTUREGAMESTATE:74,DDEMO_NEW_SHAFTBEGIN:75,DDEMO_NEW_SHAFTEND:76,DDEMO_POWERUP_EVENT_POWERUPDROP:77,DDEMO_POWERUP_EVENT_PICKUP:78,DDEMO_POWERUP_EVENT_POWERUPDROPGAMESTATE:79,DDEMO_CTF_EVENT_FLAGTAKEN_RED:80,DDEMO_CTF_EVENT_FLAGCAPTURE_RED:81,DDEMO_CTF_EVENT_FLAGDROP_RED:82,PUV3_DIR0:1,PUV3_DIR1:2,PUV3_DIR2:8,PUV3_DIR3:16,PUV3_DEAD0:32,PUV3_DEAD1:64,PUV3_DEAD2:128,PUV3_WPN0:256,PUV3_WPN1:512,PUV3_WPN2:1024,PUV3_WPN3:2048,PUV3_WPN4:4096,PUV3_WPN5:8192,PUV3_WPN6:16384,PUV3_WPN7:32768,PUV3B_WPN8:1,PUV3B_CROUCH:2,PUV3B_BALLOON:8};document.addEventListener("keydown",function(e){192===e.keyCode&&((a=!a)?(r.classList.add("open"),h.scrollTop=h.scrollHeight,l.value="",l.focus()):r.classList.remove("open"),e.preventDefault())});var a=!1,r=document.getElementById("console"),h=document.getElementById("console-content"),l=document.getElementById("console-input"),p=h.innerHTML;l.addEventListener("keydown",function(e){if(13===e.keyCode){e.preventDefault();var t=l.value.trim();o.writeText(t),0===t.indexOf("map ")?document.location.href="?mapfile="+t.substring(4):"help"===t&&(o.writeText("Available commands:"),o.writeText("help"),o.writeText("map <mapname>")),l.value=""}});var o={writeText(e){e=e.toString(),(p+="<br>"+function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}(e)).length>5e3&&(p=p.substring(p.length-5e3)),h.innerHTML=p,h.scrollTop=h.scrollHeight}},n=o,y={trunc:Math.trunc||function(e){return e<0?Math.ceil(e):Math.floor(e)},ord:e=>e.charCodeAt(0),random:e=>Math.floor(Math.random()*e),removeHtmlElement(e){var t=document.getElementById(e);t.parentNode.removeChild(t)},filterNickName(e){for(var t="",s=0;s<e.length;s++)"^"==e[s]?s++:t+=e[s];return t},getDelphiString(e){if(0==e.length)return e;var t=e[0].charCodeAt(0);return t<=e.length-1&&(e=e.substring(1,t+1)),e},getImageDimensions:e=>new Promise(function(t,s){var i=new Image;i.onload=function(){t({w:i.width,h:i.height})},i.src=e})};class c{constructor(e){this.g=e,this.rows=0,this.cols=0,this.bricks=[],this.respawns=[],this.bg=1,this.paletteImage="images/palette.png",this.paletteIndex=6,this.paletteCustomImage=null,this.paletteCustomIndex=54}async loadFromDemo(e){this.bg=e.Header.BG,0==this.bg&&(this.bg=this.g.config.default_bg),this.loadNFKMap(e.Bricks),e.PaletteBytes&&(this.paletteCustomImage="data:image/png;base64,"+e.PaletteBytes,await this.g.render.updatePaletteTexture(this.paletteCustomImage))}loadNFKMap(e){var t=e;this.rows=t.length;for(var s=0;s<t.length;s++){this.bricks[s]=[];var i=window.atob(t[s]);this.cols=i.length;for(var a=0;a<i.length;a++){var r=y.ord(i[a]);this.bricks[s][a]=r>53&&r,34!=r&&35!=r&&36!=r||this.respawns.push({row:a,col:s})}}}isBrick(e,t){return e>=this.rows||t>=this.cols||e<0||t<0||this.bricks[e][t]}getBrick(e,t){return this.bricks[e][t]}getRows(){return this.cols}getCols(){return this.rows}getRandomRespawn(){return this.respawns[y.random(respawns.length)]}}var u={keyUp:!1,keyDown:!1,keyLeft:!1,keyRight:!1};document.addEventListener("keydown",e=>{if(!(e.keyCode<37||e.keyCode>40)&&"textarea"!==e.target.nodeName.toLowerCase())switch(e.preventDefault(),e.keyCode){case 38:u.keyUp=!0;break;case 37:u.keyLeft=!0;break;case 39:u.keyRight=!0;break;case 40:u.keyDown=!0}}),document.addEventListener("keyup",e=>{if(!(e.keyCode<37||e.keyCode>40)&&"textarea"!==e.target.nodeName.toLowerCase())switch(e.preventDefault(),e.keyCode){case 38:u.keyUp=!1;break;case 37:u.keyLeft=!1;break;case 39:u.keyRight=!1;break;case 40:u.keyDown=!1}});var m=s(1),d=s.n(m);class D{constructor(e,t){this.g=e,this.stage=e.render.stage,this.player=t,this.obj=null,this.initAnimation(),this.playerName=new d.a.Text(t.displayName,{fontFamily:"Arial",fontSize:14,fill:"white",align:"center"}),this.playerName.anchor=new d.a.Point(.5,.5),this.playerName.y-=48,this.stage.addChild(this.playerName),this.playerHA=new d.a.Text("0 / 0",{fontFamily:"Arial",fontSize:12,fill:"white",align:"center"}),this.playerHA.anchor=new d.a.Point(.5,.5),this.playerHA.y-=34,this.stage.addChild(this.playerHA),this.weaponSprite=new d.a.Sprite(this.getWeaponTexture(this.player.weapon)),this.weaponSprite.anchor.set(.5),this.weaponSprite.position.x+=4,this.weaponSprite.position.y-=6,this.weaponSprite.scale.x=this.weaponSprite.scale.y=-1,this.obj.addChild(this.weaponSprite)}getWeaponTexture(e){return 0==e?new d.a.Texture(this.g.resources.gaunlett.texture,new d.a.Rectangle(0,0,i.BRICK_WIDTH,28)):1==e?new d.a.Texture(this.g.resources.machine.texture,new d.a.Rectangle(40,0,40,13)):new d.a.Texture(this.g.resources.palette.texture,new d.a.Rectangle((e-1)*i.BRICK_WIDTH,0,i.BRICK_WIDTH,i.BRICK_HEIGHT))}initAnimation(){for(var e=[],t=0;t<19;t++)e.push(d.a.Texture.fromFrame("wd_"+t+".png"));this.obj=new d.a.extras.AnimatedSprite(e),this.obj.anchor.set(.5),this.obj.animationSpeed=.3,this.obj.play();var s=this;this.obj.onFrameChange=(e=>{e==s.obj.totalFrames-1&&s.obj.gotoAndPlay(1)}),this.stage.addChild(this.obj)}play(){this.obj.playing||this.obj.gotoAndPlay(1)}stop(){this.obj.playing&&this.obj.gotoAndStop(0)}adjustPosition(e,t){0==this.player.velocityX?this.stop():this.play(),this.obj.scale.x=0==this.player.dir||3==this.player.dir?-1:1,this.obj.x=e,this.player.crouch,this.obj.y=t,this.playerName.x=e,this.playerName.y=this.obj.y-48,this.playerHA.x=e,this.playerHA.y=this.obj.y-34,this.playerHA.text=this.player.health+" / "+this.player.armor,this.weaponSprite.texture=this.getWeaponTexture(this.player.weapon),this.weaponSprite.angle=this.player.fangle}updatePlayerHA(e,t,s){}destroy(){this.stage.removeChild(this.obj),this.stage.removeChild(this.playerCenter),this.stage.removeChild(this.playerName),this.stage.removeChild(this.playerHA)}}var E=s(0),_=s.n(E),g={fire_bfg:new _.a({urls:["sounds/bfg_fire.wav"]}),fire_plasma:new _.a({urls:["sounds/plasma.wav"]}),fire_gren:new _.a({urls:["sounds/grenade.wav"]}),fire_rail:new _.a({urls:["sounds/rail.wav"]}),fire_shaft:new _.a({urls:["sounds/flight.wav"]}),fire_shaft_begin:new _.a({urls:["sounds/lg_start.wav"]}),fire_shaft_end:new _.a({urls:["sounds/lg_hum.wav"]}),fire_shotgun:new _.a({urls:["sounds/shotgun.wav"]}),fire_mach:new _.a({urls:["sounds/machine.wav"]}),fire_rocket:new _.a({urls:["sounds/rocket.wav"]}),powerup_invis:new _.a({urls:["sounds/invisibility.wav"]}),powerup_haste:new _.a({urls:["sounds/haste.wav"]}),powerup_quad:new _.a({urls:["sounds/quaddamage.wav"]}),powerup_hold:new _.a({urls:["sounds/holdable.wav"]}),powerup_regen:new _.a({urls:["sounds/regeneration.wav"]}),flagtk:new _.a({urls:["sounds/flagtk.wav"]}),flagret:new _.a({urls:["sounds/flagret.wav"]}),flagcap:new _.a({urls:["sounds/flagcap.wav"]}),jump:new _.a({urls:["sounds/sarge/jump1.wav"]}),death1:new _.a({urls:["sounds/sarge/death1.wav"]}),death2:new _.a({urls:["sounds/sarge/death2.wav"]}),death3:new _.a({urls:["sounds/sarge/death3.wav"]}),jumppad:new _.a({urls:["sounds/jumppad.wav"]}),respawn:new _.a({urls:["sounds/respawn.wav"]}),lava:new _.a({urls:["sounds/lava.wav"]}),powerup:new _.a({urls:["sounds/poweruprespawn.wav"]}),flight:new _.a({urls:["sounds/flight.wav"]}),noammo:new _.a({urls:["sounds/noammo.wav"]}),genericdata:new _.a({urls:["sounds/hit.wav"]}),gameend:new _.a({urls:["sounds/gameend.wav"]})},O={constructor(){this.volume=1},play(e){g[e].volume(this.volume),g[e].play()},setVolume(e){this.volume=e}};const P=i.PLAYER_MAX_VELOCITY_X;var w=y.trunc,f=0,M=document.getElementById("log"),A="";class v{constructor(e,t){this.player=e,this.map=t,this.defx=0,this.defy=0,this.tmpCol=0,this.tmpY=0,this.tmpSpeedX=0,this.tmpAbsMaxVelocityX=0,this.tmpSign=0,this.velocityYSpeedJump=[0,0,.4,.8,1,1.2,1.4],this.velocityXSpeedJump=[0,.33,.8,1.1,1.4,1.8,2.2],this.tmpLastWasJump=!1,this.tmpCurJump=!1,this.speedJumpDirection=0,this.tmpLastKeyUp=!1,this.tmpDjBonus=0,this.time=0,this.tmpDeltaTime=0,this.tmpDeltaPhysicFrames=0}playerphysic(e){this.defx=this.player.x,this.defy=this.player.y,this.player.velocityY=this.player.velocityY+.056,this.player.velocityY>-1&&this.player.velocityY<0&&(this.player.velocityY/=1.11),this.player.velocityY>0&&this.player.velocityY<5&&(this.player.velocityY*=1.1),this.player.velocityX<-.2||this.player.velocityX>.2?this.player.keyLeft===this.player.keyRight&&(this.player.isOnGround()?this.player.velocityX/=1.14:this.player.velocityX/=1.025):this.player.velocityX=0,0!==this.player.velocityX?this.tmpSpeedX=(this.player.velocityX<0?-1:1)*this.velocityXSpeedJump[this.player.speedJump]:this.tmpSpeedX=0,this.player.setXY(this.player.x+this.player.velocityX+this.tmpSpeedX,this.player.y+this.player.velocityY),this.player.crouch&&(this.player.isOnGround()&&(this.player.isBrickCrouchOnHead()||this.player.velocityY>0)?(this.player.velocityY=0,this.player.setY(16*w(Math.round(this.player.y)/16)+8)):this.player.isBrickCrouchOnHead()&&this.player.velocityY<0&&(this.player.velocityY=0,this.player.doublejumpCountdown=3,this.player.setY(16*w(Math.round(this.player.y)/16)+8))),0!=this.player.velocityX&&(this.tmpCol=w(Math.round(this.defx+(this.player.velocityX<0?-11:11))/32),this.tmpY=this.player.crouch?this.player.y:this.defy,(this.map.isBrick(this.tmpCol,w(Math.round(this.tmpY-(this.player.crouch?8:16))/16))||this.map.isBrick(this.tmpCol,w(Math.round(this.tmpY)/16))||this.map.isBrick(this.tmpCol,w(Math.round(this.tmpY+16)/16)))&&(this.player.setX(32*w(this.defx/32)+(this.player.velocityX<0?9:22)),this.player.velocityX=0,this.player.speedJump=0,this.defx!=this.player.x&&this.log("wall",this.player))),this.player.isOnGround()&&(this.player.isBrickOnHead()||this.player.velocityY>0)?(this.player.velocityY=0,this.player.setY(16*w(Math.round(this.player.y)/16)+8)):e.isBrickOnHead()&&this.player.velocityY<0&&(this.player.velocityY=0,this.player.doublejumpCountdown=3),this.player.velocityX<-5&&(this.player.velocityX=-5),this.player.velocityX>5&&(this.player.velocityX=5),this.player.velocityY<-5&&(this.player.velocityY=-5),this.player.velocityY>5&&(this.player.velocityY=5)}playermove(){if(this.playerphysic(this.player),this.player.doublejumpCountdown>0&&this.player.doublejumpCountdown--,this.player.isOnGround()&&(this.player.velocityY=0),this.tmpCurJump=!1,this.player.speedJump>0&&(this.player.keyUp!==this.tmpLastKeyUp||this.player.keyLeft&&-1!==this.speedJumpDirection||this.player.keyRight&&1!==this.speedJumpDirection)&&(this.player.speedJump=0,this.log("sj 0 - change keys",this.player)),this.tmpLastKeyUp=this.player.keyUp,this.player.keyUp?!this.player.isOnGround()||this.player.isBrickOnHead()||this.tmpLastWasJump||(this.player.doublejumpCountdown>4&&this.player.doublejumpCountdown<11?(this.player.doublejumpCountdown=14,this.player.velocityY=-3,0!==this.player.velocityX?this.tmpSpeedX=Math.abs(this.player.velocityX)+this.velocityXSpeedJump[this.player.speedJump]:this.tmpSpeedX=0,this.tmpSpeedX>3?(this.tmpDjBonus=this.tmpSpeedX-3,this.player.velocityY-=this.tmpDjBonus,this.log("dj higher (bonus +"+this.round(this.tmpDjBonus)+")",this.player)):this.log("dj standart",this.player),this.player.crouch=!1,O.jump()):(0===this.player.doublejumpCountdown&&(this.player.doublejumpCountdown=14,O.jump()),this.player.velocityY=-2.9,this.player.velocityY+=this.velocityYSpeedJump[this.player.speedJump],this.log("jump",player),this.player.speedJump<6&&!this.tmpLastWasJump&&this.player.keyLeft!==this.player.keyRight&&(this.speedJumpDirection=this.player.keyLeft?-1:1,this.player.speedJump++,this.log("increase sj",this.player))),this.tmpCurJump=!0):this.player.isOnGround()&&this.player.speedJump>0&&!this.player.keyDown&&(this.player.speedJump=0,this.log("sj 0 - on ground",this.player)),!this.player.keyUp&&this.player.keyDown?this.player.isOnGround()?this.player.crouch=!0:this.player.isBrickCrouchOnHead()||(this.player.crouch=!1):this.player.crouch=this.player.isOnGround()&&this.player.isBrickCrouchOnHead(),this.tmpLastWasJump=this.tmpCurJump,this.player.keyLeft!==this.player.keyRight){this.tmpAbsMaxVelocityX=P,this.player.crouch&&this.tmpAbsMaxVelocityX--,this.tmpSign=this.player.keyLeft?-1:1,this.player.velocityX*this.tmpSign<0&&(this.player.velocityX+=.8*this.tmpSign);var e=Math.abs(this.player.velocityX);e<this.tmpAbsMaxVelocityX?this.player.velocityX+=.35*this.tmpSign:e>this.tmpAbsMaxVelocityX&&(this.player.velocityX=this.tmpSign*this.tmpAbsMaxVelocityX)}}runPhysicsOneFrame(e){this.playermove()}updateGame(e){if(0===this.time&&(this.time=e-16),this.tmpDeltaTime=e-this.time,this.tmpDeltaPhysicFrames=w(this.tmpDeltaTime/16),0===this.tmpDeltaPhysicFrames)return!1;if(this.time+=16.6*this.tmpDeltaPhysicFrames,1===this.tmpDeltaPhysicFrames)this.runPhysicsOneFrame();else for(;this.tmpDeltaPhysicFrames>0;)this.runPhysicsOneFrame(),this.tmpDeltaPhysicFrames--}log(e){f++,0!==this.player.velocityX?this.tmpSpeedX=(this.player.velocityX<0?-1:1)*this.velocityXSpeedJump[pthis.layer.speedJump]:this.tmpSpeedX=0,A=f+" "+e+" (x: "+this.round(this.player.x)+", y: "+this.round(this.player.y)+", dx: "+this.round(this.tmpSpeedX)+", dy: "+this.round(this.player.velocityY)+", sj: "+this.player.speedJump+")",M.value=A+"\n"+M.value.substring(0,1e3),n.writeText(A)}round(e){return w(e)+"."+Math.abs(w(10*e)-10*w(e))}}class T{constructor(e,t,s){this.g=s,this.stage=s.render.stage,this.map=s.map,this.DXID=e,this.x=0,this.y=0,this.name=t,this.displayName=y.filterNickName(t),this.health=0,this.armor=0,this.follow=!1,this.velocityX=0,this.velocityY=0,this.crouch=!1,this.dir=0,this.dead=0,this.weapon=0,this.BALLOON=!1,this.rewardtime=0,this.fangle=0,this.ammo_mg=100,this.ammo_sg=0,this.ammo_gl=0,this.ammo_rl=0,this.ammo_sh=0,this.ammo_rg=0,this.ammo_pl=0,this.ammo_bfg=0,this.keyUp=!1,this.keyDown=!1,this.keyLeft=!1,this.keyRight=!1,this.doublejumpCountdown=0,this.cacheOnGround=!1,this.cacheBrickOnHead=!1,this.cacheBrickCrouchOnHead=!1,this.speedJump=0,this.graphics=null,this.physics=null,this._init()}_init(){this.graphics=new D(this.g,this),this.physics=new v(this,this.map)}height(){return i.BRICK_HEIGHT*(this.crouch?2:3)}width(){return i.PLAYER_WIDTH}setX(e){e!=this.x&&(this.x=e,this.updateCaches())}setY(e){e!=this.y&&(this.y=e,this.updateCaches())}setXY(e,t){e===this.x&&t===this.y||(this.x=e,this.y=t,this.updateCaches())}updateCaches(){this.updateCacheOnGround(),this.updateCacheBrickOnHead(),this.updateCacheBrickCrouchOnHead()}updateCacheOnGround(){this.cacheOnGround=this.map.isBrick(y.trunc((this.x-9)/32),y.trunc((this.y+25)/16))&&!this.map.isBrick(y.trunc((this.x-9)/32),y.trunc((this.y+23)/16))||this.map.isBrick(y.trunc(y.trunc(this.x+9)/32),y.trunc(y.trunc(this.y+25)/16))&&!this.map.isBrick(y.trunc(y.trunc(this.x+9)/32),y.trunc(y.trunc(this.y+23)/16))||this.map.isBrick(y.trunc((this.x-9)/32),y.trunc((this.y+24)/16))&&!this.map.isBrick(y.trunc((this.x-9)/32),y.trunc((this.y+8)/16))||this.map.isBrick(y.trunc((this.x+9)/32),y.trunc((this.y+24)/16))&&!this.map.isBrick(y.trunc((this.x+9)/32),y.trunc((this.y+8)/16))}updateCacheBrickCrouchOnHead(){this.cacheBrickCrouchOnHead=this.map.isBrick(y.trunc((this.x-8)/32),y.trunc((this.y-9)/16))&&!this.map.isBrick(y.trunc((this.x-8)/32),y.trunc((this.y-7)/16))||this.map.isBrick(y.trunc((this.x+8)/32),y.trunc((this.y-9)/16))&&!this.map.isBrick(y.trunc((this.x+8)/32),y.trunc((this.y-7)/16))||this.map.isBrick(y.trunc((this.x-8)/32),y.trunc((this.y-23)/16))||this.map.isBrick(y.trunc((this.x+8)/32),y.trunc((this.y-23)/16))||this.map.isBrick(y.trunc((this.x-8)/32),y.trunc((this.y-16)/16))||this.map.isBrick(y.trunc((this.x+8)/32),y.trunc((this.y-16)/16))}updateCacheBrickOnHead(){this.cacheBrickOnHead=this.map.isBrick(y.trunc((this.x-9)/32),y.trunc((this.y-25)/16))&&!this.map.isBrick(y.trunc((this.x-9)/32),y.trunc((this.y-23)/16))||this.map.isBrick(y.trunc((this.x+9)/32),y.trunc((this.y-25)/16))&&!this.map.isBrick(y.trunc((this.x+9)/32),y.trunc((this.y-23)/16))||this.map.isBrick(y.trunc((this.x-9)/32),y.trunc((this.y-24)/16))&&!this.map.isBrick(y.trunc((this.x-9)/32),y.trunc((this.y-8)/16))||this.map.isBrick(y.trunc((this.x+9)/32),y.trunc((this.y-24)/16))&&!this.map.isBrick(y.trunc((this.x+9)/32),y.trunc((this.y-8)/16))}isOnGround(){return this.cacheOnGround}isBrickOnHead(){return this.cacheBrickOnHead}isBrickCrouchOnHead(){return this.cacheBrickCrouchOnHead}destroy(){this.graphics.destroy()}}class C{constructor(e){this.g=e,this.map=e.map;var t=this;this.app=new d.a.Application(window.innerWidth,window.innerHeight,{antialias:!1,resolution:1,transparent:!0}),this.app.view.style.display="block";var s=document.getElementById("game");s.appendChild(this.app.view),this.stage=this.app.stage,this.mapGraphics=new d.a.Graphics,this.mapGraphics.beginFill(10066329),this.mapGraphics.lineStyle(1,11184810),this.stage.addChild(this.mapGraphics),this.floatCamera=!1,this.halfWidth=0,this.halfHeight=0,this.mapDx=0,this.mapDy=0,this.bricksPerLine=8,this.paletteCustomTexture=null,this.bricksPerLineCustom=0,window.addEventListener("resize",function(){t.recalcFloatCamera(t)},!1),s.onclick=function(e){for(var s=-1,i=0;i<t.g.players.length;i++)t.g.players[i].follow&&(t.g.players[i].follow=!1,(s=i+1)>t.g.players.length-1&&(s=0));-1!=s&&(t.g.players[s].follow=!0,console.log("Follow player "+t.g.players[s].displayName))}}async updatePaletteTexture(e){this.paletteCustomTexture=d.a.BaseTexture.from(e);var t=await y.getImageDimensions(e);this.bricksPerLineCustom=Math.floor(t.w/i.BRICK_WIDTH),console.log("palette loaded = "+this.paletteCustomTexture.hasLoaded),console.log("change palette. Brickes per line "+this.paletteCustomTexture.width+" "+this.bricksPerLineCustom)}renderMap(){document.body.style.background="url('images/bg_"+this.map.bg+".jpg')";var e,t,s=this.map.getRows(),a=this.map.getCols();for(e=0;e<s;e++)for(t=0;t<a;t++)if(this.map.isBrick(t,e)){var r=this.map.getBrick(t,e),h=this.g.resources.palette.texture,l=this.bricksPerLine;null!=this.map.paletteCustomImage&&r<=181?(h=this.paletteCustomTexture,l=this.bricksPerLineCustom,r-=this.map.paletteCustomIndex):r-=this.map.paletteIndex;var p=new d.a.Texture(h,new d.a.Rectangle(r%l*i.BRICK_WIDTH,Math.floor(r/l)*i.BRICK_HEIGHT,i.BRICK_WIDTH,i.BRICK_HEIGHT)),o=new d.a.Sprite(p);o.position.x=t*i.BRICK_WIDTH,o.position.y=e*i.BRICK_HEIGHT,this.mapGraphics.addChild(o)}this.recalcFloatCamera(this),this.app.render(this.stage)}recalcFloatCamera(e){console.log("resize event"),e.app.view.width=window.innerWidth-20,e.app.view.height=window.innerHeight,e.floatCamera=e.map.getRows()>window.innerHeight/16||e.map.getCols()>(window.innerWidth-20)/32,e.floatCamera?(e.halfWidth=Math.floor((window.innerWidth-20)/2),e.halfHeight=Math.floor(window.innerHeight/2)):(e.mapGraphics.x=e.mapDx=Math.floor((window.innerWidth-20-32*e.map.getCols())/2),e.mapGraphics.y=e.mapDy=Math.floor((window.innerHeight-16*e.map.getRows())/2))}renderGame(e){var t=e.x+this.mapDx,s=e.y+this.mapDy;this.floatCamera&&e.follow&&(this.mapDx=this.mapGraphics.x=this.halfWidth-e.x,this.mapDy=this.mapGraphics.y=this.halfHeight-e.y),e.graphics.adjustPosition(t,s),this.app.render(this.stage)}}var R=s(2);class k{constructor(e){this.g=e,this.players=e.players,this.data={},this.frameId=0}loadFromQuery(e){var t=window.location.href.slice(window.location.href.indexOf("?")+1);if(0===t.indexOf("demourl=")){var s=decodeURIComponent(t.substring(8)).replace(/\+/g," ");s="http://nfk.harpywar.com:8080/demo?url="+s+"&full=true",n.writeText("loading demo from url"),this.load(s,e)}}load(e,t){var s=this;this._loadJSON(e,function(e){y.removeHtmlElement("loading"),s.data=e,t(s)},function(e){y.removeHtmlElement("loading"),n.writeText("error loading demo"),console.error(e)})}_spawnPlayer(e,t){var s=new T(e,t,this.g);0==this.players.length&&(s.follow=!0),this.players.push(s)}nextFrame(e){var t=this.data.DemoUnits[this.frameId],s=t.DemoUnit;if(e!=t.DData.gametic)return!0;if(this.frameId++,this.frameId>this.data.DemoUnits.length-1)return O.play("gameend"),console.log("end of demo"),!1;switch(t.DData.type0){case i.DDEMO_PLAYERPOSV3:for(var a=0;a<this.players.length;a++)s.DXID==this.players[a].DXID&&(this.players[a].x=s.x,this.players[a].y=s.y,this.players[a].velocityX=s.inertiax,this.players[a].velocityY=s.inertiay,(s.PUV3&i.PUV3_DIR0)==i.PUV3_DIR0&&(this.players[a].dir=0),(s.PUV3&i.PUV3_DIR1)==i.PUV3_DIR1&&(this.players[a].dir=1),(s.PUV3&i.PUV3_DIR2)==i.PUV3_DIR2&&(this.players[a].dir=2),(s.PUV3&i.PUV3_DIR3)==i.PUV3_DIR3&&(this.players[a].dir=3),(s.PUV3&i.PUV3_DEAD0)==i.PUV3_DEAD0&&(this.players[a].dead=0),(s.PUV3&i.PUV3_DEAD1)==i.PUV3_DEAD1&&(this.players[a].dead=1),(s.PUV3&i.PUV3_DEAD2)==i.PUV3_DEAD2&&(this.players[a].dead=2),(s.PUV3&i.PUV3_WPN0)==i.PUV3_WPN0&&(this.players[a].weapon=0),(s.PUV3&i.PUV3_WPN1)==i.PUV3_WPN1&&(this.players[a].weapon=1),(s.PUV3&i.PUV3_WPN2)==i.PUV3_WPN2&&(this.players[a].weapon=2),(s.PUV3&i.PUV3_WPN3)==i.PUV3_WPN3&&(this.players[a].weapon=3),(s.PUV3&i.PUV3_WPN4)==i.PUV3_WPN4&&(this.players[a].weapon=4),(s.PUV3&i.PUV3_WPN5)==i.PUV3_WPN5&&(this.players[a].weapon=5),(s.PUV3&i.PUV3_WPN6)==i.PUV3_WPN6&&(this.players[a].weapon=6),(s.PUV3&i.PUV3_WPN7)==i.PUV3_WPN7&&(this.players[a].weapon=7),(s.PUV3B&i.PUV3B_WPN8)==i.PUV3B_WPN8&&(this.players[a].weapon=8),this.players[a].crouch=(s.PUV3B&i.PUV3B_CROUCH)==i.PUV3B_CROUCH,this.players[a].BALLOON=(s.PUV3B&i.PUV3B_BALLOON)==i.PUV3B_BALLOON,0==this.players[a].dead&&(s.PUV3&i.PUV3_DEAD1)==i.PUV3_DEAD1?this.players[a].graphics.stop():this.players[a].graphics.play(),this.players[a].dead>0&&(s.PUV3&i.PUV3_DEAD0)==i.PUV3_DEAD0&&this.players[a].rewardtime>0&&(this.players[a].rewardtime=0),this.players[a].fangle=s.wpnang,1!=this.players[a].dir&&3!=this.players[a].dir||(this.players[a].fangle>127?this.players[a].fangle=255-this.players[a].fangle:this.players[a].fangle<=127&&(this.players[a].fangle=255-this.players[a].fangle)),this.players[a].ammo_mg=s.currammo,this.players[a].ammo_sg=s.currammo,this.players[a].ammo_gl=s.currammo,this.players[a].ammo_rl=s.currammo,this.players[a].ammo_sh=s.currammo,this.players[a].ammo_rg=s.currammo,this.players[a].ammo_pl=s.currammo,this.players[a].ammo_bfg=s.currammo);break;case i.DDEMO_HAUPDATE:for(a=0;a<this.players.length;a++)s.DXID==this.players[a].DXID&&(this.players[a].health=s.health,this.players[a].armor=s.armor,this.players[a].dead&&O.play("death"+(y.random(3)+1)));break;case i.DDEMO_CREATEPLAYERV2:var r=y.getDelphiString(s.netname);this._spawnPlayer(s.DXID,r),console.log("player joined "+r);break;case i.DDEMO_DROPPLAYER:for(var h=0;h<this.players.length;h++)this.players[h].DXID==s.DXID&&(console.log("player left "+this.players[h].name),this.players[h].destroy(),this.players.splice(h,1));break;case i.DDEMO_CTF_EVENT_FLAGPICKUP:case i.DDEMO_CTF_EVENT_FLAGTAKEN:O.play("flagtk");break;case i.DDEMO_CTF_EVENT_FLAGRETURN:O.play("flagret");break;case i.DDEMO_CTF_EVENT_FLAGCAPTURE:O.play("flagcap");break;case i.DDEMO_EARNPOWERUP:0==s.type1&&O.play("powerup_regen"),1==s.type1&&O.play("powerup_hold"),2==s.type1&&O.play("powerup_haste"),3==s.type1&&O.play("powerup_quad"),4==s.type1&&O.play("powerup_invis");break;case i.DDEMO_KILLOBJECT:break;case i.DDEMO_FIREBFG:O.play("fire_bfg");break;case i.DDEMO_FIREPLASMAV2:case i.DDEMO_FIREPLASMA:O.play("fire_plasma");break;case i.DDEMO_FIREGRENV2:case i.DDEMO_FIREGREN:O.play("fire_gren");break;case i.DDEMO_FIRERAIL:O.play("fire_rail");break;case i.DDEMO_FIRESHAFT:O.play("fire_shaft");break;case i.DDEMO_NEW_SHAFTBEGIN:O.play("fire_shaft_begin");break;case i.DDEMO_NEW_SHAFTEND:O.play("fire_shaft_end");break;case i.DDEMO_FIRESHOTGUN:O.play("fire_shotgun");break;case i.DDEMO_FIREMACH:O.play("fire_mach");break;case i.DDEMO_FIREROCKET:O.play("fire_rocket");break;case i.DDEMO_JUMPSOUND:O.play("jump");break;case i.DDEMO_JUMPPADSOUND:O.play("jumppad");break;case i.DDEMO_RESPAWNSOUND:O.play("respawn");break;case i.DDEMO_LAVASOUND:O.play("lava");break;case i.DDEMO_POWERUPSOUND:O.play("powerup");break;case i.DDEMO_FLIGHTSOUND:O.play("flight");break;case i.DDEMO_NOAMMOSOUND:O.play("noammo");break;case i.DDEMO_GENERICSOUNDDATA:case i.DDEMO_GENERICSOUNDSTATDATA:}return this.nextFrame(e),!0}_loadJSON(e,t,s){var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&(200===i.status?t&&t(JSON.parse(i.responseText)):s&&s(i))},i.open("GET",e,!0),i.send()}}var N=new(s.n(R).a);document.getElementById("fps").appendChild(N.domElement);var U=new class{constructor(){this.resources={},this.map=new c(this),this.render=new C(this),this.players=[],this.demo=new k(this),this.gameObjects=[],this.config={mode:"production",volume:.3,default_bg:2},this.const={mode:"production",fps:50,volume:.3,default_bg:2},O.setVolume(this.config.volume)}};async function b(){await U.map.loadFromDemo(U.demo.data.Map),U.render.renderMap();var e=0;requestAnimationFrame(function t(s){N.begin();for(var a=0;a<U.players.length;a++)U.players[a].physics.updateGame(s),U.render.renderGame(U.players[a]);U.demo.nextFrame(e)&&(++e>i.FPS&&(e=0),requestAnimationFrame(t),N.end())})}console.log("mode: "+U.config.mode),PIXI.loader.add("sarge_wd","images/models/sarge/wd.json").add("palette","images/palette.png").add("machine","images/Mgun_ex.png").add("gaunlett","images/Gauntlet.png").load(function(e,t){U.resources=t,"development"==U.config.mode?U.demo.load("demo4.json",b):U.demo.loadFromQuery(b);console.log("demo loaded")})}]);