!function(e){var t={};function i(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)i.d(s,a,function(t){return e[t]}.bind(null,a));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/build/",i(i.s=3)}([function(e,t){e.exports=Howl},function(e,t){e.exports=PIXI},function(e,t){e.exports=Stats},function(e,t,i){"use strict";i.r(t);var s={BRICK_WIDTH:32,BRICK_HEIGHT:16,PLAYER_WIDTH:20,PLAYER_MAX_VELOCITY_X:3,DDEMO_VERSION:0,DDEMO_FIREROCKET:1,DDEMO_PLAYERPOS:2,DDEMO_TIMESET:3,DDEMO_CREATEPLAYER:4,DDEMO_KILLOBJECT:5,DDEMO_FIREBFG:6,DDEMO_FIREPLASMA:7,DDEMO_FIREGREN:8,DDEMO_FIRERAIL:9,DDEMO_FIRESHAFT:10,DDEMO_FIRESHOTGUN:11,DDEMO_FIREMACH:12,DDEMO_ITEMDISSAPEAR:13,DDEMO_ITEMAPEAR:14,DDEMO_DAMAGEPLAYER:15,DDEMO_HAUPDATE:16,DDEMO_FLASH:17,DDEMO_JUMPSOUND:18,DDEMO_GAMEEND:19,DDEMO_RESPAWNSOUND:20,DDEMO_JUMPPADSOUND:21,DDEMO_LAVASOUND:22,DDEMO_POWERUPSOUND:23,DDEMO_EARNPOWERUP:24,DDEMO_READYPRESS:25,DDEMO_FLIGHTSOUND:26,DDEMO_EARNREWARD:27,DDEMO_STATS:28,DDEMO_GAMESTATE:29,DDEMO_TRIXARENAEND:30,DDEMO_OBJCHANGESTATE:31,DDEMO_CORPSESPAWN:32,DDEMO_GRENADESYNC:33,DDEMO_STATS2:34,DDEMO_PLAYERPOSV2:35,DDEMO_FIREGRENV2:36,DDEMO_NOAMMOSOUND:37,DDEMO_GAUNTLETSTATE:38,DDEMO_STATS3:39,DDEMO_FIREPLASMAV2:40,DDEMO_PLAYERPOSV3:41,DDEMO_BUBBLE:42,DDEMO_MPSTATE:43,DDEMO_NETRAIL:44,DDEMO_NETPARTICLE:45,DDEMO_NETTIMEUPDATE:46,DDEMO_NETSVMATCHSTART:47,DDEMO_DROPPLAYER:48,DDEMO_CREATEPLAYERV2:49,DDEMO_SPECTATORCONNECT:50,DDEMO_SPECTATORDISCONNECT:51,DDEMO_CHATMESSAGE:52,DDEMO_PLAYERRENAME:53,DDEMO_PLAYERMODELCHANGE:54,DDEMO_GENERICSOUNDDATA:55,DDEMO_GENERICSOUNDSTATDATA:56,DDEMO_TEAMSELECT:57,DDEMO_CTF_EVENT_FLAGTAKEN:58,DDEMO_CTF_EVENT_FLAGCAPTURE:59,DDEMO_CTF_EVENT_FLAGDROP:60,DDEMO_CTF_EVENT_FLAGPICKUP:61,DDEMO_CTF_EVENT_FLAGDROP_APPLY:62,DDEMO_CTF_EVENT_FLAGRETURN:63,DDEMO_CTF_GAMESTATE:64,DDEMO_CTF_EVENT_FLAGDROPGAMESTATE:65,DDEMO_CTF_GAMESTATESCORE:66,DDEMO_CTF_FLAGCARRIER:67,DDEMO_DOM_CAPTURE:68,DDEMO_DOM_SCORECHANGED:69,DDEMO_WPN_EVENT_WEAPONDROP:70,DDEMO_WPN_EVENT_PICKUP:71,DDEMO_WPN_EVENT_WEAPONDROP_APPLY:72,DDEMO_WPN_EVENT_WEAPONDROPGAMESTATE:73,DDEMO_DOM_CAPTUREGAMESTATE:74,DDEMO_NEW_SHAFTBEGIN:75,DDEMO_NEW_SHAFTEND:76,DDEMO_POWERUP_EVENT_POWERUPDROP:77,DDEMO_POWERUP_EVENT_PICKUP:78,DDEMO_POWERUP_EVENT_POWERUPDROPGAMESTATE:79,DDEMO_CTF_EVENT_FLAGTAKEN_RED:80,DDEMO_CTF_EVENT_FLAGCAPTURE_RED:81,DDEMO_CTF_EVENT_FLAGDROP_RED:82};document.addEventListener("keydown",function(e){192===e.keyCode&&((a=!a)?(r.classList.add("open"),h.scrollTop=h.scrollHeight,l.value="",l.focus()):r.classList.remove("open"),e.preventDefault())});var a=!1,r=document.getElementById("console"),h=document.getElementById("console-content"),l=document.getElementById("console-input"),n=h.innerHTML;l.addEventListener("keydown",function(e){if(13===e.keyCode){e.preventDefault();var t=l.value.trim();p.writeText(t),0===t.indexOf("map ")?document.location.href="?mapfile="+t.substring(4):"help"===t&&(p.writeText("Available commands:"),p.writeText("help"),p.writeText("map <mapname>")),l.value=""}});var p={writeText(e){e=e.toString(),(n+="<br>"+function(e){return e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")}(e)).length>5e3&&(n=n.substring(n.length-5e3)),h.innerHTML=n,h.scrollTop=h.scrollHeight}},o=p,c={trunc:Math.trunc||function(e){return e<0?Math.ceil(e):Math.floor(e)},ord:e=>e.charCodeAt(0),random:e=>Math.floor(Math.random()*e),removeHtmlElement(e){var t=document.getElementById(e);t.parentNode.removeChild(t)},filterNickName(e){for(var t="",i=0;i<e.length;i++)"^"==e[i]?i++:t+=e[i];return t},getDelphiString(e){if(0==e.length)return e;var t=e[0].charCodeAt(0);return t<=e.length-1&&(e=e.substring(1,t+1)),e},getImageDimensions:e=>new Promise(function(t,i){var s=new Image;s.onload=function(){t({w:s.width,h:s.height})},s.src=e})};class y{constructor(e){this.g=e,this.rows=0,this.cols=0,this.bricks=[],this.respawns=[],this.bg=1,this.paletteImage="images/palette.png",this.paletteIndex=6,this.paletteCustomImage=null,this.paletteCustomIndex=54}async loadFromDemo(e){this.bg=e.Header.BG,0==this.bg&&(this.bg=this.g.config.default_bg),this.loadNFKMap(e.Bricks),e.PaletteBytes&&(this.paletteCustomImage="data:image/png;base64,"+e.PaletteBytes,await this.g.render.updatePaletteTexture(this.paletteCustomImage))}loadNFKMap(e){var t=e;this.rows=t.length;for(var i=0;i<t.length;i++){this.bricks[i]=[];var s=window.atob(t[i]);this.cols=s.length;for(var a=0;a<s.length;a++){var r=c.ord(s[a]);this.bricks[i][a]=r>53&&r,34!=r&&35!=r&&36!=r||this.respawns.push({row:a,col:i})}}}isBrick(e,t){return e>=this.rows||t>=this.cols||e<0||t<0||this.bricks[e][t]}getBrick(e,t){return this.bricks[e][t]}getRows(){return this.cols}getCols(){return this.rows}getRandomRespawn(){return this.respawns[c.random(respawns.length)]}}var u={keyUp:!1,keyDown:!1,keyLeft:!1,keyRight:!1};document.addEventListener("keydown",e=>{if(!(e.keyCode<37||e.keyCode>40)&&"textarea"!==e.target.nodeName.toLowerCase())switch(e.preventDefault(),e.keyCode){case 38:u.keyUp=!0;break;case 37:u.keyLeft=!0;break;case 39:u.keyRight=!0;break;case 40:u.keyDown=!0}}),document.addEventListener("keyup",e=>{if(!(e.keyCode<37||e.keyCode>40)&&"textarea"!==e.target.nodeName.toLowerCase())switch(e.preventDefault(),e.keyCode){case 38:u.keyUp=!1;break;case 37:u.keyLeft=!1;break;case 39:u.keyRight=!1;break;case 40:u.keyDown=!1}});var d=i(1),m=i.n(d);class D{constructor(e,t){this.stage=e,this.player=t,this.playerGraphics=new m.a.Graphics,this.playerGraphics.beginFill(11184895),this.playerGraphics.drawRect(0,0,this.player.width(),this.player.height()),this.playerGraphics.endFill(),this.stage.addChild(this.playerGraphics),this.playerCenter=new m.a.Graphics,this.playerCenter.beginFill(170),this.playerCenter.drawRect(0,0,2,2),this.playerCenter.endFill(),this.stage.addChild(this.playerCenter),this.playerName=new m.a.Text(c.filterNickName(t.name),{fontFamily:"Arial",fontSize:14,fill:"white",align:"center"}),this.playerName.anchor=new m.a.Point(.5,.5),this.playerName.height=80,this.playerName.scale.x=this.playerName.scale.y,this.stage.addChild(this.playerName),this.playerHA=new m.a.Text("0 / 0",{fontFamily:"Arial",fontSize:14,fill:"white",align:"center"}),this.playerHA.anchor=new m.a.Point(.5,.5),this.playerHA.height=70,this.playerHA.scale.x=this.playerName.scale.y,this.stage.addChild(this.playerHA),this.initHeight=this.playerGraphics.height}adjustPosition(e,t){this.playerGraphics.x=e-10,this.player.crouch?(this.playerGraphics.y=t-8,this.playerGraphics.height=this.initHeight/3*2):(this.playerGraphics.y=t-24,this.playerGraphics.height=this.initHeight),this.playerCenter.x=e-1,this.playerCenter.y=t-1,this.playerName.x=e,this.playerName.y=this.playerGraphics.y-25,this.playerHA.x=e,this.playerHA.y=this.playerGraphics.y-9,this.playerHA.setText(this.player.health+" / "+this.player.armor)}updatePlayerHA(e,t,i){}destroy(){this.stage.removeChild(this.playerGraphics),this.stage.removeChild(this.playerCenter),this.stage.removeChild(this.playerName),this.stage.removeChild(this.playerHA)}}var E=i(0),_=i.n(E),O={fire_bfg:new _.a({urls:["sounds/bfg_fire.wav"]}),fire_plasma:new _.a({urls:["sounds/plasma.wav"]}),fire_gren:new _.a({urls:["sounds/grenade.wav"]}),fire_rail:new _.a({urls:["sounds/rail.wav"]}),fire_shaft:new _.a({urls:["sounds/flight.wav"]}),fire_shaft_begin:new _.a({urls:["sounds/lg_start.wav"]}),fire_shaft_end:new _.a({urls:["sounds/lg_hum.wav"]}),fire_shotgun:new _.a({urls:["sounds/shotgun.wav"]}),fire_mach:new _.a({urls:["sounds/machine.wav"]}),fire_rocket:new _.a({urls:["sounds/rocket.wav"]}),powerup_invis:new _.a({urls:["sounds/invisibility.wav"]}),powerup_haste:new _.a({urls:["sounds/haste.wav"]}),powerup_quad:new _.a({urls:["sounds/quaddamage.wav"]}),powerup_hold:new _.a({urls:["sounds/holdable.wav"]}),powerup_regen:new _.a({urls:["sounds/regeneration.wav"]}),flagtk:new _.a({urls:["sounds/flagtk.wav"]}),flagret:new _.a({urls:["sounds/flagret.wav"]}),flagcap:new _.a({urls:["sounds/flagcap.wav"]}),jump:new _.a({urls:["sounds/sarge/jump1.wav"]}),death1:new _.a({urls:["sounds/sarge/death1.wav"]}),death2:new _.a({urls:["sounds/sarge/death2.wav"]}),death3:new _.a({urls:["sounds/sarge/death3.wav"]}),jumppad:new _.a({urls:["sounds/jumppad.wav"]}),respawn:new _.a({urls:["sounds/respawn.wav"]}),lava:new _.a({urls:["sounds/lava.wav"]}),powerup:new _.a({urls:["sounds/poweruprespawn.wav"]}),flight:new _.a({urls:["sounds/flight.wav"]}),noammo:new _.a({urls:["sounds/noammo.wav"]}),genericdata:new _.a({urls:["sounds/hit.wav"]}),gameend:new _.a({urls:["sounds/gameend.wav"]})},g={constructor(){this.volume=1},play(e){O[e].volume(this.volume),O[e].play()},setVolume(e){this.volume=e}};const w=s.PLAYER_MAX_VELOCITY_X;var M=c.trunc,f=0,v=document.getElementById("log"),T="";class C{constructor(e,t){this.player=e,this.map=t,this.defx=0,this.defy=0,this.tmpCol=0,this.tmpY=0,this.tmpSpeedX=0,this.tmpAbsMaxVelocityX=0,this.tmpSign=0,this.velocityYSpeedJump=[0,0,.4,.8,1,1.2,1.4],this.velocityXSpeedJump=[0,.33,.8,1.1,1.4,1.8,2.2],this.tmpLastWasJump=!1,this.tmpCurJump=!1,this.speedJumpDirection=0,this.tmpLastKeyUp=!1,this.tmpDjBonus=0}playerphysic(e){this.defx=this.player.x,this.defy=this.player.y,this.player.velocityY=this.player.velocityY+.056,this.player.velocityY>-1&&this.player.velocityY<0&&(this.player.velocityY/=1.11),this.player.velocityY>0&&this.player.velocityY<5&&(this.player.velocityY*=1.1),this.player.velocityX<-.2||this.player.velocityX>.2?this.player.keyLeft===this.player.keyRight&&(this.player.isOnGround()?this.player.velocityX/=1.14:this.player.velocityX/=1.025):this.player.velocityX=0,0!==this.player.velocityX?this.tmpSpeedX=(this.player.velocityX<0?-1:1)*this.velocityXSpeedJump[this.player.speedJump]:this.tmpSpeedX=0,this.player.setXY(this.player.x+this.player.velocityX+this.tmpSpeedX,this.player.y+this.player.velocityY),this.player.crouch&&(this.player.isOnGround()&&(this.player.isBrickCrouchOnHead()||this.player.velocityY>0)?(this.player.velocityY=0,this.player.setY(16*M(Math.round(this.player.y)/16)+8)):this.player.isBrickCrouchOnHead()&&this.player.velocityY<0&&(this.player.velocityY=0,this.player.doublejumpCountdown=3,this.player.setY(16*M(Math.round(this.player.y)/16)+8))),0!=this.player.velocityX&&(this.tmpCol=M(Math.round(this.defx+(this.player.velocityX<0?-11:11))/32),this.tmpY=this.player.crouch?this.player.y:this.defy,(this.map.isBrick(this.tmpCol,M(Math.round(this.tmpY-(this.player.crouch?8:16))/16))||this.map.isBrick(this.tmpCol,M(Math.round(this.tmpY)/16))||this.map.isBrick(this.tmpCol,M(Math.round(this.tmpY+16)/16)))&&(this.player.setX(32*M(this.defx/32)+(this.player.velocityX<0?9:22)),this.player.velocityX=0,this.player.speedJump=0,this.defx!=this.player.x&&this.log("wall",this.player))),this.player.isOnGround()&&(this.player.isBrickOnHead()||this.player.velocityY>0)?(this.player.velocityY=0,this.player.setY(16*M(Math.round(this.player.y)/16)+8)):e.isBrickOnHead()&&this.player.velocityY<0&&(this.player.velocityY=0,this.player.doublejumpCountdown=3),this.player.velocityX<-5&&(this.player.velocityX=-5),this.player.velocityX>5&&(this.player.velocityX=5),this.player.velocityY<-5&&(this.player.velocityY=-5),this.player.velocityY>5&&(this.player.velocityY=5)}playermove(){if(this.playerphysic(this.player),this.player.doublejumpCountdown>0&&this.player.doublejumpCountdown--,this.player.isOnGround()&&(this.player.velocityY=0),this.tmpCurJump=!1,this.player.speedJump>0&&(this.player.keyUp!==this.tmpLastKeyUp||this.player.keyLeft&&-1!==this.speedJumpDirection||this.player.keyRight&&1!==this.speedJumpDirection)&&(this.player.speedJump=0,this.log("sj 0 - change keys",this.player)),this.tmpLastKeyUp=this.player.keyUp,this.player.keyUp?!this.player.isOnGround()||this.player.isBrickOnHead()||this.tmpLastWasJump||(this.player.doublejumpCountdown>4&&this.player.doublejumpCountdown<11?(this.player.doublejumpCountdown=14,this.player.velocityY=-3,0!==this.player.velocityX?this.tmpSpeedX=Math.abs(this.player.velocityX)+this.velocityXSpeedJump[this.player.speedJump]:this.tmpSpeedX=0,this.tmpSpeedX>3?(this.tmpDjBonus=this.tmpSpeedX-3,this.player.velocityY-=this.tmpDjBonus,this.log("dj higher (bonus +"+this.round(this.tmpDjBonus)+")",this.player)):this.log("dj standart",this.player),this.player.crouch=!1,g.jump()):(0===this.player.doublejumpCountdown&&(this.player.doublejumpCountdown=14,g.jump()),this.player.velocityY=-2.9,this.player.velocityY+=this.velocityYSpeedJump[this.player.speedJump],this.log("jump",player),this.player.speedJump<6&&!this.tmpLastWasJump&&this.player.keyLeft!==this.player.keyRight&&(this.speedJumpDirection=this.player.keyLeft?-1:1,this.player.speedJump++,this.log("increase sj",this.player))),this.tmpCurJump=!0):this.player.isOnGround()&&this.player.speedJump>0&&!this.player.keyDown&&(this.player.speedJump=0,this.log("sj 0 - on ground",this.player)),!this.player.keyUp&&this.player.keyDown?this.player.isOnGround()?this.player.crouch=!0:this.player.isBrickCrouchOnHead()||(this.player.crouch=!1):this.player.crouch=this.player.isOnGround()&&this.player.isBrickCrouchOnHead(),this.tmpLastWasJump=this.tmpCurJump,this.player.keyLeft!==this.player.keyRight){this.tmpAbsMaxVelocityX=w,this.player.crouch&&this.tmpAbsMaxVelocityX--,this.tmpSign=this.player.keyLeft?-1:1,this.player.velocityX*this.tmpSign<0&&(this.player.velocityX+=.8*this.tmpSign);var e=Math.abs(this.player.velocityX);e<this.tmpAbsMaxVelocityX?this.player.velocityX+=.35*this.tmpSign:e>this.tmpAbsMaxVelocityX&&(this.player.velocityX=this.tmpSign*this.tmpAbsMaxVelocityX)}}log(e){f++,0!==this.player.velocityX?this.tmpSpeedX=(this.player.velocityX<0?-1:1)*this.velocityXSpeedJump[pthis.layer.speedJump]:this.tmpSpeedX=0,T=f+" "+e+" (x: "+this.round(this.player.x)+", y: "+this.round(this.player.y)+", dx: "+this.round(this.tmpSpeedX)+", dy: "+this.round(this.player.velocityY)+", sj: "+this.player.speedJump+")",v.value=T+"\n"+v.value.substring(0,1e3),o.writeText(T)}round(e){return M(e)+"."+Math.abs(M(10*e)-10*M(e))}}function A(e){e.physics.playermove()}var k=0,R=0;function P(e,t){if(0===k&&(k=t-16),0===(R=M((t-k)/16)))return!1;if(k+=16.6*R,1===R)A(e);else for(;R>0;)A(e),R--}class N{constructor(e,t,i){this.stage=i.render.stage,this.map=i.map,this.DXID=e,this.x=0,this.y=0,this.name=t,this.health=0,this.armor=0,this.follow=!1,this.velocityX=0,this.velocityY=0,this.keyUp=!1,this.keyDown=!1,this.keyLeft=!1,this.keyRight=!1,this.crouch=!1,this.doublejumpCountdown=0,this.cacheOnGround=!1,this.cacheBrickOnHead=!1,this.cacheBrickCrouchOnHead=!1,this.speedJump=0,this.graphics=null,this.physics=null,this._init()}_init(){this.graphics=new D(this.stage,this),this.physics=new C(this,this.map)}isDead(){return this.health<=0}height(){return s.BRICK_HEIGHT*(this.crouch?2:3)}width(){return s.PLAYER_WIDTH}setX(e){e!=this.x&&(this.x=e,this.updateCaches())}setY(e){e!=this.y&&(this.y=e,this.updateCaches())}setXY(e,t){e===this.x&&t===this.y||(this.x=e,this.y=t,this.updateCaches())}updateCaches(){this.updateCacheOnGround(),this.updateCacheBrickOnHead(),this.updateCacheBrickCrouchOnHead()}updateCacheOnGround(){this.cacheOnGround=this.map.isBrick(c.trunc((this.x-9)/32),c.trunc((this.y+25)/16))&&!this.map.isBrick(c.trunc((this.x-9)/32),c.trunc((this.y+23)/16))||this.map.isBrick(c.trunc(c.trunc(this.x+9)/32),c.trunc(c.trunc(this.y+25)/16))&&!this.map.isBrick(c.trunc(c.trunc(this.x+9)/32),c.trunc(c.trunc(this.y+23)/16))||this.map.isBrick(c.trunc((this.x-9)/32),c.trunc((this.y+24)/16))&&!this.map.isBrick(c.trunc((this.x-9)/32),c.trunc((this.y+8)/16))||this.map.isBrick(c.trunc((this.x+9)/32),c.trunc((this.y+24)/16))&&!this.map.isBrick(c.trunc((this.x+9)/32),c.trunc((this.y+8)/16))}updateCacheBrickCrouchOnHead(){this.cacheBrickCrouchOnHead=this.map.isBrick(c.trunc((this.x-8)/32),c.trunc((this.y-9)/16))&&!this.map.isBrick(c.trunc((this.x-8)/32),c.trunc((this.y-7)/16))||this.map.isBrick(c.trunc((this.x+8)/32),c.trunc((this.y-9)/16))&&!this.map.isBrick(c.trunc((this.x+8)/32),c.trunc((this.y-7)/16))||this.map.isBrick(c.trunc((this.x-8)/32),c.trunc((this.y-23)/16))||this.map.isBrick(c.trunc((this.x+8)/32),c.trunc((this.y-23)/16))||this.map.isBrick(c.trunc((this.x-8)/32),c.trunc((this.y-16)/16))||this.map.isBrick(c.trunc((this.x+8)/32),c.trunc((this.y-16)/16))}updateCacheBrickOnHead(){this.cacheBrickOnHead=this.map.isBrick(c.trunc((this.x-9)/32),c.trunc((this.y-25)/16))&&!this.map.isBrick(c.trunc((this.x-9)/32),c.trunc((this.y-23)/16))||this.map.isBrick(c.trunc((this.x+9)/32),c.trunc((this.y-25)/16))&&!this.map.isBrick(c.trunc((this.x+9)/32),c.trunc((this.y-23)/16))||this.map.isBrick(c.trunc((this.x-9)/32),c.trunc((this.y-24)/16))&&!this.map.isBrick(c.trunc((this.x-9)/32),c.trunc((this.y-8)/16))||this.map.isBrick(c.trunc((this.x+9)/32),c.trunc((this.y-24)/16))&&!this.map.isBrick(c.trunc((this.x+9)/32),c.trunc((this.y-8)/16))}isOnGround(){return this.cacheOnGround}isBrickOnHead(){return this.cacheBrickOnHead}isBrickCrouchOnHead(){return this.cacheBrickCrouchOnHead}destroy(){this.graphics.destroy()}}class S{constructor(e){this.map=e.map,this.renderer=m.a.autoDetectRenderer(window.innerWidth,window.innerHeight,{antialias:!1,resolution:1,transparent:!0}),this.renderer.view.style.display="block",document.getElementById("game").appendChild(this.renderer.view),this.stage=new m.a.Stage(0),this.mapGraphics=new m.a.Graphics,this.mapGraphics.beginFill(10066329),this.mapGraphics.lineStyle(1,11184810),this.stage.addChild(this.mapGraphics),this.floatCamera=!1,this.halfWidth=0,this.halfHeight=0,this.mapDx=0,this.mapDy=0,this.paletteTexture=m.a.BaseTexture.fromImage(this.map.paletteImage),this.bricksPerLine=8,this.paletteCustomTexture=null,this.bricksPerLineCustom=0;var t=this;window.addEventListener("resize",function(){t.recalcFloatCamera(t)},!1)}async updatePaletteTexture(e){this.paletteCustomTexture=m.a.BaseTexture.fromImage(e);var t=await c.getImageDimensions(e);this.bricksPerLineCustom=Math.floor(t.w/s.BRICK_WIDTH),console.log("palette loaded = "+this.paletteCustomTexture.hasLoaded),console.log("change palette. Brickes per line "+this.paletteCustomTexture.width+" "+this.bricksPerLineCustom)}renderMap(){document.body.style.background="url('images/bg_"+this.map.bg+".jpg')";var e,t,i=this.map.getRows(),a=this.map.getCols();for(e=0;e<i;e++)for(t=0;t<a;t++)if(this.map.isBrick(t,e)){var r=this.map.getBrick(t,e),h=this.paletteTexture,l=this.bricksPerLine;null!=this.map.paletteCustomImage&&r<=181?(h=this.paletteCustomTexture,l=this.bricksPerLineCustom,r-=this.map.paletteCustomIndex):r-=this.map.paletteIndex;var n=new m.a.Texture(h,new m.a.Rectangle(r%l*s.BRICK_WIDTH,Math.floor(r/l)*s.BRICK_HEIGHT,s.BRICK_WIDTH,s.BRICK_HEIGHT)),p=new m.a.Sprite(n);p.position.x=t*s.BRICK_WIDTH,p.position.y=e*s.BRICK_HEIGHT,console.log(this.bricksPerLine),this.mapGraphics.drawRect(32*t,16*e,31,15),this.mapGraphics.addChild(p)}this.recalcFloatCamera(this),this.renderer.render(this.stage)}recalcFloatCamera(e){console.log("resize event"),e.renderer.view.width=window.innerWidth-20,e.renderer.view.height=window.innerHeight,e.floatCamera=e.map.getRows()>window.innerHeight/16||e.map.getCols()>(window.innerWidth-20)/32,e.floatCamera?(e.halfWidth=Math.floor((window.innerWidth-20)/2),e.halfHeight=Math.floor(window.innerHeight/2)):(e.mapGraphics.x=e.mapDx=Math.floor((window.innerWidth-20-32*e.map.getCols())/2),e.mapGraphics.y=e.mapDy=Math.floor((window.innerHeight-16*e.map.getRows())/2))}renderGame(e){var t=e.x+this.mapDx,i=e.y+this.mapDy;this.floatCamera&&e.follow&&(this.mapDx=this.mapGraphics.x=this.halfWidth-e.x,this.mapDy=this.mapGraphics.y=this.halfHeight-e.y),e.graphics.adjustPosition(t,i),this.renderer.render(this.stage)}}var b=i(2);class x{constructor(e){this.g=e,this.players=e.players,this.data={},this.frameId=0}loadFromQuery(e){var t=window.location.href.slice(window.location.href.indexOf("?")+1);if(0===t.indexOf("demourl=")){var i=decodeURIComponent(t.substring(8)).replace(/\+/g," ");i="http://nfk.harpywar.com:8080/demo?url="+i+"&full=true",o.writeText("loading demo from url"),this.load(i,e)}}load(e,t){var i=this;this._loadJSON(e,function(e){c.removeHtmlElement("loading"),i.data=e,t(i)},function(e){c.removeHtmlElement("loading"),o.writeText("error loading demo"),console.error(e)})}_spawnPlayer(e,t){var i=new N(e,t,this.g);0==this.players.length&&(i.follow=!0),this.players.push(i)}nextFrame(e){if(++this.frameId>this.data.DemoUnits.length-1)return g.play("gameend"),!1;var t=this.data.DemoUnits[this.frameId],i=t.DemoUnit;switch(t.DData.type0){case s.DDEMO_PLAYERPOSV3:for(var a=0;a<this.players.length;a++)i.DXID==this.players[a].DXID&&(this.players[a].x=i.x,this.players[a].y=i.y,this.players[a].velocityX=i.inertiax,this.players[a].velocityY=i.inertiay);break;case s.DDEMO_HAUPDATE:for(a=0;a<this.players.length;a++)i.DXID==this.players[a].DXID&&(this.players[a].health=i.health,this.players[a].armor=i.armor,this.players[a].isDead()&&g.play("death"+(c.random(3)+1)));break;case s.DDEMO_CREATEPLAYERV2:var r=c.getDelphiString(i.netname);this._spawnPlayer(i.DXID,r),console.log("player joined "+r);break;case s.DDEMO_DROPPLAYER:for(var h=0;h<this.players.length;h++)this.players[h].DXID==i.DXID&&(console.log("player left "+this.players[h].name),this.players[h].destroy(),this.players.splice(h,1));break;case s.DDEMO_CTF_EVENT_FLAGPICKUP:case s.DDEMO_CTF_EVENT_FLAGTAKEN:g.play("flagtk");break;case s.DDEMO_CTF_EVENT_FLAGRETURN:g.play("flagret");break;case s.DDEMO_CTF_EVENT_FLAGCAPTURE:g.play("flagcap");break;case s.DDEMO_EARNPOWERUP:0==i.type1&&g.play("powerup_regen"),1==i.type1&&g.play("powerup_hold"),2==i.type1&&g.play("powerup_haste"),3==i.type1&&g.play("powerup_quad"),4==i.type1&&g.play("powerup_invis");break;case s.DDEMO_KILLOBJECT:break;case s.DDEMO_FIREBFG:g.play("fire_bfg");break;case s.DDEMO_FIREPLASMAV2:case s.DDEMO_FIREPLASMA:g.play("fire_plasma");break;case s.DDEMO_FIREGRENV2:case s.DDEMO_FIREGREN:g.play("fire_gren");break;case s.DDEMO_FIRERAIL:g.play("fire_rail");break;case s.DDEMO_FIRESHAFT:g.play("fire_shaft");break;case s.DDEMO_NEW_SHAFTBEGIN:g.play("fire_shaft_begin");break;case s.DDEMO_NEW_SHAFTEND:g.play("fire_shaft_end");break;case s.DDEMO_FIRESHOTGUN:g.play("fire_shotgun");break;case s.DDEMO_FIREMACH:g.play("fire_mach");break;case s.DDEMO_FIREROCKET:g.play("fire_rocket");break;case s.DDEMO_JUMPSOUND:g.play("jump");break;case s.DDEMO_JUMPPADSOUND:g.play("jumppad");break;case s.DDEMO_RESPAWNSOUND:g.play("respawn");break;case s.DDEMO_LAVASOUND:g.play("lava");break;case s.DDEMO_POWERUPSOUND:g.play("powerup");break;case s.DDEMO_FLIGHTSOUND:g.play("flight");break;case s.DDEMO_NOAMMOSOUND:g.play("noammo");break;case s.DDEMO_GENERICSOUNDDATA:case s.DDEMO_GENERICSOUNDSTATDATA:}return!0}_loadJSON(e,t,i){var s=new XMLHttpRequest;s.onreadystatechange=function(){s.readyState===XMLHttpRequest.DONE&&(200===s.status?t&&t(JSON.parse(s.responseText)):i&&i(s))},s.open("GET",e,!0),s.send()}}var I=new(i.n(b).a);document.getElementById("fps").appendChild(I.domElement);var G=new class{constructor(){this.map=new y(this),this.players=[],this.demo=new x(this),this.gameObjects=[],this.render=new S(this),this.config={mode:"production",demoSpeed:1,volume:.3,default_bg:2},g.setVolume(this.config.volume)}};async function L(){await G.map.loadFromDemo(G.demo.data.Map),G.render.renderMap();var e=0;requestAnimationFrame(function t(i){I.begin();for(var s=0;s<G.players.length;s++)P(G.players[s],i),G.render.renderGame(G.players[s]);for(s=0;s<G.config.demoSpeed;s++)G.demo.nextFrame(e);++e>60&&(e=0),requestAnimationFrame(t),I.end()})}console.log("mode: "+G.config.mode),"development"==G.config.mode?G.demo.load("demo4.json",L):G.demo.loadFromQuery(L),console.log("demo loaded")}]);